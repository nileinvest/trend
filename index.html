<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moneyline Dashboard Live</title>
    <style>
        body { margin: 0; padding: 20px; background-color: #131722; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; color: #e0e0e0; }
        .container { max-width: 1600px; margin: 0 auto; background: #1e222d; border-radius: 8px; border: 1px solid #2a2e39; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        
        /* Barra di Ricerca */
        .controls { padding: 15px; border-bottom: 1px solid #2a2e39; display: flex; gap: 10px; }
        input[type="text"] {
            background: #2a2e39; border: 1px solid #363a45; color: white; padding: 10px; border-radius: 4px; width: 300px; outline: none;
        }
        input[type="text"]:focus { border-color: #2962ff; }

        /* Tabella */
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #2a2e39; color: #b2b5be; padding: 15px; text-align: left; text-transform: uppercase; font-size: 12px; cursor: pointer; user-select: none; }
        th:hover { background: #363a45; color: white; }
        td { padding: 12px 15px; border-bottom: 1px solid #2a2e39; }
        tr:hover { background: #262b3a; }

        /* Stili Celle */
        .buy { color: #00ff00; font-weight: bold; background: rgba(0,255,0,0.1); padding: 4px 8px; border-radius: 4px; display: inline-block; text-align: center; min-width: 60px; }
        .sell { color: #ff4444; font-weight: bold; background: rgba(255,68,68,0.1); padding: 4px 8px; border-radius: 4px; display: inline-block; text-align: center; min-width: 60px; }
        .neutral { color: #888; }
        
        .ticker { font-weight: bold; color: #2962ff; font-size: 15px; }
        .market { color: #b2b5be; font-style: italic; } /* Stile per la nuova colonna Markets */
        .price { font-family: 'Courier New', monospace; font-weight: bold; color: #fff; font-size: 15px; }
        
        /* Loading */
        #loading { padding: 20px; text-align: center; color: #888; }
    </style>
</head>
<body>

    <div class="container">
        <div class="controls">
            <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Cerca Ticker o Market...">
            <div style="padding: 10px; color: #666; font-size: 12px; margin-left: auto;">Aggiornamento live: <span id="lastUpdate">In attesa...</span></div>
        </div>

        <table id="dataTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Ticker ⬍</th>
                    <th onclick="sortTable(1)">Markets ⬍</th> <th onclick="sortTable(2)">Prezzo ⬍</th>
                    <th onclick="sortTable(3)">Trend W ⬍</th>
                    <th onclick="sortTable(4)">Giorni W ⬍</th>
                    <th onclick="sortTable(5)">Trend D ⬍</th>
                    <th onclick="sortTable(6)">Giorni D ⬍</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
        <div id="loading">Caricamento dati in corso...</div>
    </div>

<script>
    // URL del CSV pubblicato (Google Sheets)
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdzNpQjqwdqK5ZO16Kd8hlNNtmm31gxOy1AAb49CDXqxMwEOmUpowc9H4rHWPbb9rd874zmOtcDTUo/pub?gid=1410987574&single=true&output=csv';

    async function loadData() {
        try {
            const response = await fetch(csvUrl + '&cache=' + Date.now()); // Evita la cache
            const data = await response.text();
            parseCSV(data);
            document.getElementById('loading').style.display = 'none';
            
            const now = new Date();
            document.getElementById('lastUpdate').innerText = now.toLocaleTimeString();
        } catch (error) {
            console.error('Errore caricamento:', error);
            document.getElementById('loading').innerText = 'Errore caricamento dati.';
        }
    }

    function parseCSV(text) {
        const rows = text.split(/\r?\n/);
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        rows.forEach((row, index) => {
            if (index === 0 || !row.trim()) return; // Salta intestazione e righe vuote
            
            // Gestione separatore CSV (virgola o punto e virgola)
            const sep = row.includes(';') ? ';' : ',';
            // Regex complessa per gestire celle con virgole all'interno (es. "1,200.00")
            const cells = row.split(sep).map(val => val.replace(/^"|"$/g, '').trim());

            // MAPPING COLONNE (Indici base 0):
            // A=0 (Ticker), B=1 (MARKETS), E=4 (Trend W), G=6 (Giorni W), I=8 (Trend D), K=10 (Giorni D), L=11 (Prezzo)
            
            const ticker = cells[0];
            const market = cells[1] || ''; // NUOVA COLONNA B
            const trendW = cells[4] || '';
            const daysW = cells[6] || '';
            const trendD = cells[8] || '';
            const daysD = cells[10] || '';
            const price = cells[11] || '---';

            if (ticker) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="ticker">${ticker}</td>
                    <td class="market">${market}</td>
                    <td class="price">${price}</td>
                    <td>${formatTrend(trendW)}</td>
                    <td>${daysW}</td>
                    <td>${formatTrend(trendD)}</td>
                    <td>${daysD}</td>
                `;
                tbody.appendChild(tr);
            }
        });
        filterTable(); // Riapplica il filtro se c'è testo nella barra
    }

    function formatTrend(val) {
        if (!val) return '<span class="neutral">-</span>';
        val = val.toUpperCase();
        if (val.includes('BUY') || val.includes('LONG')) return `<span class="buy">● BUY</span>`;
        if (val.includes('SELL') || val.includes('SHORT')) return `<span class="sell">● SELL</span>`;
        return val;
    }

    // --- FUNZIONI DI ORDINAMENTO E FILTRO ---

    function filterTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toUpperCase();
        const table = document.getElementById('dataTable');
        const tr = table.getElementsByTagName('tr');

        for (let i = 1; i < tr.length; i++) {
            const tds = tr[i].getElementsByTagName('td');
            let txtValue = "";
            // Cerca nel Ticker (0) e nel Market (1)
            if (tds[0] || tds[1]) {
                txtValue = (tds[0].textContent || tds[0].innerText) + " " + (tds[1].textContent || tds[1].innerText);
            }
            
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }

    function sortTable(n) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("dataTable");
        switching = true;
        dir = "asc"; 
        
        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];
                
                let xContent = x.innerText.toLowerCase();
                let yContent = y.innerText.toLowerCase();

                // Gestione numeri per ordinamento corretto
                let xNum = parseFloat(xContent.replace(/[^0-9.-]+/g,""));
                let yNum = parseFloat(yContent.replace(/[^0-9.-]+/g,""));

                if (!isNaN(xNum) && !isNaN(yNum) && (n === 2 || n === 4 || n === 6)) { // Colonne numeriche (Prezzo, Giorni)
                    if (dir == "asc") {
                        if (xNum > yNum) { shouldSwitch = true; break; }
                    } else {
                        if (xNum < yNum) { shouldSwitch = true; break; }
                    }
                } else { // Colonne testo
                    if (dir == "asc") {
                        if (xContent > yContent) { shouldSwitch = true; break; }
                    } else {
                        if (xContent < yContent) { shouldSwitch = true; break; }
                    }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount ++;      
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
    }

    // Avvio e Auto-refresh
    loadData();
    setInterval(loadData, 30000); // Aggiorna ogni 30 secondi
</script>

</body>
</html>

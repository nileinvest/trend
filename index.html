<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NILE Dashboard</title>
    <title>Dashboard</title>
    <script data-memberstack-app="app_cmlf9re4g00u40ss19rl32mj9" src="https://static.memberstack.com/scripts/v2/memberstack.js" type="text/javascript"></script>

    <style>
@@ -38,16 +37,17 @@
        .filter-star-toggle { cursor: pointer; font-size: 20px; color: rgba(255,255,255,0.2); transition: all 0.2s; }
        .filter-star-toggle.enabled { color: #ffca28; text-shadow: 0 0 10px rgba(255, 202, 40, 0.5); }

        /* --- LOGIN SCREEN --- */
        /* --- FIX DEFINITIVO LOGIN SCREEN --- */
        #login-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            display: none;
            display: none; /* Attivato da JS */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            /* Overlay scuro + Immagine Stock Professionale Candlestick */
            background: linear-gradient(rgba(19, 23, 34, 0.7), rgba(19, 23, 34, 0.9)), 
                        url('https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
@@ -105,8 +105,7 @@

        /* --- DASHBOARD ELEMENTS --- */
        #dashboard-screen { display: none; }
        .logout-btn { background: transparent; border: 1px solid #3d4151; color: #8d92a3; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 15px; transition: 0.2s; }
        .logout-btn:hover { background: #3d4151; color: #fff; }
        .logout-btn { background: transparent; border: 1px solid #3d4151; color: #8d92a3; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 15px; }

        #premium-banner { 
            background: #2962ff; 
@@ -120,20 +119,6 @@
            margin-bottom: 15px;
            border-radius: 4px;
        }

        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
@@ -147,7 +132,7 @@ <h1>NILE</h1>
    </div>

    <div id="dashboard-screen">
        <div id="premium-banner">‚ö†Ô∏è FREE PLAN - Limited to 5 stocks. Upgrade to Premium for full access.</div>
        <div id="premium-banner">WARNING: FREE PLAN - Limited View. Upgrade to Premium for full access.</div>

        <div class="data-section">
            <div class="header-panel">
@@ -167,7 +152,7 @@ <h2>Dashboard</h2>
                <div class="info-container">
                    <div id="status">‚óè AUTO-UPDATE 4:00 AM Italian time</div>
                    <div style="margin-top: 10px; font-size: 11px; color: #8d92a3;">
                        User: <span data-ms-member="email">Loading...</span>
                        User: <span data-ms-member="email">...</span>
                    </div>
                </div>
            </div>
@@ -255,7 +240,7 @@ <h2>Dashboard</h2>
    }

    function updateCounters() {
        let buyCount = 0, sellCount = 0, buyGreen = 0, buyRed = 0;
        let buyCount = 0; let sellCount = 0; let buyGreen = 0; let buyRed = 0;
        const rows = document.getElementById("tableBody").getElementsByTagName("tr");
        for (let row of rows) {
            if (row.style.display !== "none") {
@@ -285,28 +270,20 @@ <h2>Dashboard</h2>
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            let rowCount = 0;
            
            lines.forEach((line, index) => {
                if (index === 0 || !line) return;
                if (!isPremiumUser && rowCount >= 5) return; 
                
                const c = parseCSVLine(line, sep);
                const ticker = c[0] || "";
                if (ticker.length < 2) return;
                
                const market = c[1]||"", sector = c[17]||"-", industry = c[18]||"-", 
                      lastP = c[14]||"-", trendW = c[4]||"", flipW = c[6]||"", 
                      varW = c[15]||"-", trendD = c[9]||"", flipD = c[11]||"", varD = c[16]||"-";
                
                const market = c[1]||"", sector = c[17]||"-", industry = c[18]||"-", lastP = c[14]||"-", trendW = c[4]||"", flipW = c[6]||"", varW = c[15]||"-", trendD = c[9]||"", flipD = c[11]||"", varD = c[16]||"-";
                const isFav = favorites.includes(ticker);
                const formatSign = v => v.toUpperCase().includes('BUY') ? `<span class="buy-pill">${v}</span>` : 
                                       v.toUpperCase().includes('SELL') ? `<span class="sell-pill">${v}</span>` : v;
                const formatSign = v => v.toUpperCase().includes('BUY') ? `<span class="buy-pill">${v}</span>` : v.toUpperCase().includes('SELL') ? `<span class="sell-pill">${v}</span>` : v;
                const formatVar = v => {
                    if (v === "-") return v;
                    const n = parseFloat(v.replace(',','.').replace('%',''));
                    return isNaN(n) ? v : `<span class="${n>0?'pos-var':n<0?'neg-var':''}">${v}</span>`;
                };
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="ticker-style">${ticker}</td>
@@ -326,13 +303,10 @@ <h2>Dashboard</h2>
                tbody.appendChild(tr);
                rowCount++;
            });
            
            filterTable();
            if (currentSort.column !== null) sortTable(currentSort.column, true);
            updateCounters();
        } catch (e) { 
            console.error("Update Error:", e); 
        }
        } catch (e) { console.error("Update Error:", e); }
    }

    window.filterTable = function() {
@@ -364,8 +338,7 @@ <h2>Dashboard</h2>
        rows.sort((a, b) => {
            let valA = (n===11) ? a.cells[n].getAttribute('data-val') : a.cells[n].innerText;
            let valB = (n===11) ? b.cells[n].getAttribute('data-val') : b.cells[n].innerText;
            let x = valA.toLowerCase().replace('%','').replace(',','.'), 
                y = valB.toLowerCase().replace('%','').replace(',','.');
            let x = valA.toLowerCase().replace('%','').replace(',','.'), y = valB.toLowerCase().replace('%','').replace(',','.');
            let numX = parseFloat(x), numY = parseFloat(y);
            let res = (!isNaN(numX) && !isNaN(numY)) ? numX - numY : x.localeCompare(y);
            return currentSort.ascending ? res : -res;
@@ -381,84 +354,25 @@ <h2>Dashboard</h2>
        setTimeout(() => { update(); scheduleAutoUpdate(); }, target - now);
    }

    // --- GESTIONE LOGIN/DASHBOARD CON DEBUGGING MIGLIORATO ---
    // --- GESTIONE LOGIN/DASHBOARD ---
    window.addEventListener('load', async () => {
        console.log("üöÄ Pagina caricata, inizializzo Memberstack...");
        
        const memberstack = window.$memberstackDom;
        
        if (!memberstack) {
            console.error("‚ùå Memberstack non caricato!");
            document.getElementById('login-screen').style.display = 'flex';
            return;
        }

        // Attendi che Memberstack sia pronto
        setTimeout(async () => {
            try {
                console.log("üîç Controllo stato utente...");
                const { data: member } = await memberstack.getCurrentMember();
                
                console.log("üìä Risultato getCurrentMember:", member);
                
                if (!member) {
                    // UTENTE NON LOGGATO
                    console.log("‚ùå Utente non loggato - mostro login screen");
                    document.getElementById('login-screen').style.display = 'flex';
                    document.getElementById('dashboard-screen').style.display = 'none';
                } else {
                    // UTENTE LOGGATO
                    console.log("‚úÖ Utente loggato:", member.email || member.id);
                    console.log("üì¶ Plan Connections:", member.planConnections);
                    
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('dashboard-screen').style.display = 'block';
                    
                    // Controlla se √® Premium - VERSIONE MIGLIORATA
                    if (member.planConnections && Array.isArray(member.planConnections)) {
                        // Log tutti i plan IDs per debugging
                        member.planConnections.forEach(pc => {
                            console.log("üé´ Plan trovato:", pc.planId, pc);
                        });
                        
                        // Controlla se uno dei piani √® Premium
                        // Adatta questi valori ai tuoi plan IDs effettivi di Memberstack
                        isPremiumUser = member.planConnections.some(pc => {
                            const planId = pc.planId.toLowerCase();
                            return planId.includes('premium') || 
                                   planId === 'pln_premium-0lnx' || // Sostituisci con il tuo plan ID esatto
                                   pc.status === 'ACTIVE';
                        });
                    }
                    
                    console.log("üíé √à Premium?", isPremiumUser);
                    
                    if (!isPremiumUser) {
                        console.log("‚ö†Ô∏è Utente FREE - mostro banner e limito a 5 righe");
                        document.getElementById('premium-banner').style.display = 'block';
                    }
                    
                    // Carica i dati
                    await update();
                    scheduleAutoUpdate();
                }
            } catch (error) {
                console.error("üí• Errore durante il controllo utente:", error);
                // In caso di errore, mostra login screen come fallback
            const { data: member } = await memberstack.getCurrentMember();
            if (!member) {
                // UTENTE NON LOGGATO
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('dashboard-screen').style.display = 'none';
            } else {
                // UTENTE LOGGATO
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard-screen').style.display = 'block';
                isPremiumUser = member.planConnections && member.planConnections.some(pc => pc.planId === "premium" || pc.planId.startsWith("pln_"));
                if (!isPremiumUser) document.getElementById('premium-banner').style.display = 'block';
                update();
                scheduleAutoUpdate();
            }
        }, 500); // Timeout ridotto a 500ms
    });

    // Event listener per logout
    document.addEventListener('click', async (e) => {
        if (e.target.matches('[data-ms-action="logout"]')) {
            console.log("üëã Logout in corso...");
            const memberstack = window.$memberstackDom;
            await memberstack.logout();
            window.location.reload();
        }
        }, 800);
    });
</script>
</body>
